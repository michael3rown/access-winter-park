(function($){var delimiter=new Array();var tags_callbacks=new Array();$.fn.doAutosize=function(o){var minWidth=$(this).data('minwidth'),maxWidth=$(this).data('maxwidth'),val='',input=$(this),testSubject=$('#'+$(this).data('tester_id'));if(val===(val=input.val())){return;}
var escaped=val.replace(/&/g,'&amp;').replace(/\s/g,' ').replace(/</g,'&lt;').replace(/>/g,'&gt;');testSubject.html(escaped);var testerWidth=testSubject.width(),newWidth=(testerWidth+o.comfortZone)>=minWidth?testerWidth+o.comfortZone:minWidth,currentWidth=input.width(),isValidWidthChange=(newWidth<currentWidth&&newWidth>=minWidth)||(newWidth>minWidth&&newWidth<maxWidth);if(isValidWidthChange){input.width(newWidth);}};$.fn.resetAutosize=function(options){var minWidth=$(this).data('minwidth')||options.minInputWidth||$(this).width(),maxWidth=$(this).data('maxwidth')||options.maxInputWidth||($(this).closest('.tagsinput').width()-options.inputPadding),val='',input=$(this),testSubject=$('<tester/>').css({position:'absolute',top:-9999,left:-9999,width:'auto',fontSize:input.css('fontSize'),fontFamily:input.css('fontFamily'),fontWeight:input.css('fontWeight'),letterSpacing:input.css('letterSpacing'),whiteSpace:'nowrap'}),testerId=$(this).attr('id')+'_autosize_tester';if(!$('#'+testerId).length>0){testSubject.attr('id',testerId);testSubject.appendTo('body');}
input.data('minwidth',minWidth);input.data('maxwidth',maxWidth);input.data('tester_id',testerId);input.css('width',minWidth);};$.fn.addTag=function(value,options){options=jQuery.extend({focus:false,callback:true},options);this.each(function(){var id=$(this).attr('id');var tagslist=$(this).val().split(delimiter[id]);if(tagslist[0]==''){tagslist=new Array();}
value=jQuery.trim(value);if(options.unique){var skipTag=$(tagslist).tagExist(value);if(skipTag==true){$('#'+id+'_tag').addClass('not_valid');}}else{var skipTag=false;}
if(value!=''&&skipTag!=true){$('<span>').addClass('tag').append($('<span>').text(value).append('&nbsp;&nbsp;'),$('<a>',{href:'#',title:'Removing tag',text:'x'}).click(function(){return $('#'+id).removeTag(escape(value));})).insertBefore('#'+id+'_addTag');tagslist.push(value);$('#'+id+'_tag').val('');if(options.focus){$('#'+id+'_tag').focus();}else{$('#'+id+'_tag').blur();}
$.fn.tagsInput.updateTagsField(this,tagslist);if(options.callback&&tags_callbacks[id]&&tags_callbacks[id]['onAddTag']){var f=tags_callbacks[id]['onAddTag'];f.call(this,value);}
if(tags_callbacks[id]&&tags_callbacks[id]['onChange'])
{var i=tagslist.length;var f=tags_callbacks[id]['onChange'];f.call(this,$(this),tagslist[i-1]);}}});return false;};$.fn.removeTag=function(value){value=unescape(value);this.each(function(){var id=$(this).attr('id');var old=$(this).val().split(delimiter[id]);$('#'+id+'_tagsinput .tag').remove();str='';for(i=0;i<old.length;i++){if(old[i]!=value){str=str+delimiter[id]+old[i];}}
$.fn.tagsInput.importTags(this,str);if(tags_callbacks[id]&&tags_callbacks[id]['onRemoveTag']){var f=tags_callbacks[id]['onRemoveTag'];f.call(this,value);}});return false;};$.fn.tagExist=function(val){return(jQuery.inArray(val,$(this))>=0);};$.fn.importTags=function(str){id=$(this).attr('id');$('#'+id+'_tagsinput .tag').remove();$.fn.tagsInput.importTags(this,str);}
$.fn.tagsInput=function(options){var settings=jQuery.extend({interactive:true,defaultText:'add a tag',minChars:0,width:'300px',height:'100px',autocomplete:{selectFirst:false},'hide':true,'delimiter':',','unique':true,removeWithBackspace:true,placeholderColor:'#666666',autosize:true,comfortZone:20,inputPadding:6*2},options);this.each(function(){if(settings.hide){$(this).hide();}
var id=$(this).attr('id')
var data=jQuery.extend({pid:id,real_input:'#'+id,holder:'#'+id+'_tagsinput',input_wrapper:'#'+id+'_addTag',fake_input:'#'+id+'_tag'},settings);delimiter[id]=data.delimiter;if(settings.onAddTag||settings.onRemoveTag||settings.onChange){tags_callbacks[id]=new Array();tags_callbacks[id]['onAddTag']=settings.onAddTag;tags_callbacks[id]['onRemoveTag']=settings.onRemoveTag;tags_callbacks[id]['onChange']=settings.onChange;}
var markup='<div id="'+id+'_tagsinput" class="tagsinput"><div id="'+id+'_addTag">';if(settings.interactive){markup=markup+'<input id="'+id+'_tag" value="" data-default="'+settings.defaultText+'" />';}
markup=markup+'</div><div class="tags_clear"></div></div>';$(markup).insertAfter(this);$(data.holder).css('width',settings.width);$(data.holder).css('height',settings.height);if($(data.real_input).val()!=''){$.fn.tagsInput.importTags($(data.real_input),$(data.real_input).val());}
if(settings.interactive){$(data.fake_input).val($(data.fake_input).attr('data-default'));$(data.fake_input).css('color',settings.placeholderColor);$(data.fake_input).resetAutosize(settings);$(data.holder).bind('click',data,function(event){$(event.data.fake_input).focus();});$(data.fake_input).bind('focus',data,function(event){if($(event.data.fake_input).val()==$(event.data.fake_input).attr('data-default')){$(event.data.fake_input).val('');}
$(event.data.fake_input).css('color','#000000');});if(settings.autocomplete_url!=undefined){autocomplete_options={source:settings.autocomplete_url};for(attrname in settings.autocomplete){autocomplete_options[attrname]=settings.autocomplete[attrname];}
if(jQuery.Autocompleter!==undefined){$(data.fake_input).autocomplete(settings.autocomplete_url,settings.autocomplete);$(data.fake_input).bind('result',data,function(event,data,formatted){if(data){$('#'+id).addTag(data[0]+"",{focus:true,unique:(settings.unique)});}});}else if(jQuery.ui.autocomplete!==undefined){$(data.fake_input).autocomplete(autocomplete_options);$(data.fake_input).bind('autocompleteselect',data,function(event,ui){$(event.data.real_input).addTag(ui.item.value,{focus:true,unique:(settings.unique)});return false;});}}else{$(data.fake_input).bind('blur',data,function(event){var d=$(this).attr('data-default');if($(event.data.fake_input).val()!=''&&$(event.data.fake_input).val()!=d){if((event.data.minChars<=$(event.data.fake_input).val().length)&&(!event.data.maxChars||(event.data.maxChars>=$(event.data.fake_input).val().length)))
$(event.data.real_input).addTag($(event.data.fake_input).val(),{focus:true,unique:(settings.unique)});}else{$(event.data.fake_input).val($(event.data.fake_input).attr('data-default'));$(event.data.fake_input).css('color',settings.placeholderColor);}
return false;});}
$(data.fake_input).bind('keypress',data,function(event){if(event.which==event.data.delimiter.charCodeAt(0)||event.which==13){event.preventDefault();if((event.data.minChars<=$(event.data.fake_input).val().length)&&(!event.data.maxChars||(event.data.maxChars>=$(event.data.fake_input).val().length)))
$(event.data.real_input).addTag($(event.data.fake_input).val(),{focus:true,unique:(settings.unique)});$(event.data.fake_input).resetAutosize(settings);return false;}else if(event.data.autosize){$(event.data.fake_input).doAutosize(settings);}});data.removeWithBackspace&&$(data.fake_input).bind('keydown',function(event)
{if(event.keyCode==8&&$(this).val()=='')
{event.preventDefault();var last_tag=$(this).closest('.tagsinput').find('.tag:last').text();var id=$(this).attr('id').replace(/_tag$/,'');last_tag=last_tag.replace(/[\s]+x$/,'');$('#'+id).removeTag(escape(last_tag));$(this).trigger('focus');}});$(data.fake_input).blur();if(data.unique){$(data.fake_input).keydown(function(event){if(event.keyCode==8||String.fromCharCode(event.which).match(/\w+|[áéíóúÁÉÍÓÚñÑ,/]+/)){$(this).removeClass('not_valid');}});}}
return false;});return this;};$.fn.tagsInput.updateTagsField=function(obj,tagslist){var id=$(obj).attr('id');$(obj).val(tagslist.join(delimiter[id]));};$.fn.tagsInput.importTags=function(obj,val){$(obj).val('');var id=$(obj).attr('id');var tags=val.split(delimiter[id]);for(i=0;i<tags.length;i++){$(obj).addTag(tags[i],{focus:false,callback:false});}
if(tags_callbacks[id]&&tags_callbacks[id]['onChange'])
{var f=tags_callbacks[id]['onChange'];f.call(obj,obj,tags[i]);}};})(jQuery);
(function($){'use strict';var defaultNamespace='file_upload',undef='undefined',func='function',FileUpload,methods,MultiLoader=function(callBack,numOrList){var loaded=0,list=[];if(numOrList){if(numOrList.length){list=numOrList;}else{list[numOrList-1]=null;}}
this.complete=function(){loaded+=1;if(loaded===list.length){callBack(list);loaded=0;list=[];}};this.push=function(item){list.push(item);};this.getList=function(){return list;};},SequenceHandler=function(){var sequence=[];this.push=function(callBack){sequence.push(callBack);if(sequence.length===1){callBack();}};this.next=function(){sequence.shift();if(sequence.length){sequence[0]();}};};FileUpload=function(container){var fileUpload=this,uploadForm,fileInput,settings={namespace:defaultNamespace,uploadFormFilter:function(index){return true;},fileInputFilter:function(index){return true;},cssClass:defaultNamespace,dragDropSupport:true,dropZone:container,url:function(form){return form.attr('action');},method:function(form){return form.attr('method');},fieldName:function(input){return input.attr('name');},formData:function(form){return form.serializeArray();},requestHeaders:null,multipart:true,multiFileRequest:false,withCredentials:false,forceIframeUpload:false,sequentialUploads:false,maxChunkSize:null,maxFileReaderSize:50000000,replaceFileInput:true},documentListeners={},dropZoneListeners={},protocolRegExp=/^http(s)?:\/\//,optionsReference,multiLoader=new MultiLoader(function(list){if(typeof settings.onLoadAll===func){settings.onLoadAll(list);}}),sequenceHandler=new SequenceHandler(),completeNext=function(){multiLoader.complete();sequenceHandler.next();},isXHRUploadCapable=function(){return typeof XMLHttpRequest!==undef&&typeof XMLHttpRequestUpload!==undef&&typeof File!==undef&&(!settings.multipart||typeof FormData!==undef||(typeof FileReader!==undef&&typeof XMLHttpRequest.prototype.sendAsBinary===func));},initEventHandlers=function(){if(settings.dragDropSupport){if(typeof settings.onDocumentDragEnter===func){documentListeners['dragenter.'+settings.namespace]=function(e){settings.onDocumentDragEnter(e);};}
if(typeof settings.onDocumentDragLeave===func){documentListeners['dragleave.'+settings.namespace]=function(e){settings.onDocumentDragLeave(e);};}
documentListeners['dragover.'+settings.namespace]=fileUpload.onDocumentDragOver;documentListeners['drop.'+settings.namespace]=fileUpload.onDocumentDrop;$(document).bind(documentListeners);if(typeof settings.onDragEnter===func){dropZoneListeners['dragenter.'+settings.namespace]=function(e){settings.onDragEnter(e);};}
if(typeof settings.onDragLeave===func){dropZoneListeners['dragleave.'+settings.namespace]=function(e){settings.onDragLeave(e);};}
dropZoneListeners['dragover.'+settings.namespace]=fileUpload.onDragOver;dropZoneListeners['drop.'+settings.namespace]=fileUpload.onDrop;settings.dropZone.bind(dropZoneListeners);}
fileInput.bind('change.'+settings.namespace,fileUpload.onChange);},removeEventHandlers=function(){$.each(documentListeners,function(key,value){$(document).unbind(key,value);});$.each(dropZoneListeners,function(key,value){settings.dropZone.unbind(key,value);});fileInput.unbind('change.'+settings.namespace);},isChunkedUpload=function(settings){return typeof settings.uploadedBytes!==undef;},createProgressEvent=function(lengthComputable,loaded,total){var event;if(typeof document.createEvent===func&&typeof ProgressEvent!==undef){event=document.createEvent('ProgressEvent');if(typeof event.initProgressEvent===func){event.initProgressEvent('progress',false,false,lengthComputable,loaded,total);return event;}}
event={lengthComputable:true,loaded:loaded,total:total};return event;},getProgressTotal=function(files,index,settings){var i,total;if(typeof settings.progressTotal===undef){if(files[index]){total=files[index].size;settings.progressTotal=total?total:1;}else{total=0;for(i=0;i<files.length;i+=1){total+=files[i].size;}
settings.progressTotal=total;}}
return settings.progressTotal;},handleGlobalProgress=function(event,files,index,xhr,settings){var progressEvent,loaderList,globalLoaded=0,globalTotal=0;if(event.lengthComputable&&typeof settings.onProgressAll===func){settings.progressLoaded=parseInt(event.loaded/event.total*getProgressTotal(files,index,settings),10);loaderList=multiLoader.getList();$.each(loaderList,function(index,item){globalLoaded+=item[3].progressLoaded||0;globalTotal+=getProgressTotal(item[0],item[1],item[3]);});progressEvent=createProgressEvent(true,globalLoaded,globalTotal);settings.onProgressAll(progressEvent,loaderList);}},handleLoadEvent=function(event,files,index,xhr,settings){var progressEvent;if(isChunkedUpload(settings)){settings.uploadedBytes+=settings.chunkSize;progressEvent=createProgressEvent(true,settings.uploadedBytes,files[index].size);if(typeof settings.onProgress===func){settings.onProgress(progressEvent,files,index,xhr,settings);}
handleGlobalProgress(progressEvent,files,index,xhr,settings);if(settings.uploadedBytes<files[index].size){if(typeof settings.resumeUpload===func){settings.resumeUpload(event,files,index,xhr,settings,function(){upload(event,files,index,xhr,settings,true);});}else{upload(event,files,index,xhr,settings,true);}
return;}}
settings.progressLoaded=getProgressTotal(files,index,settings);if(typeof settings.onLoad===func){settings.onLoad(event,files,index,xhr,settings);}
completeNext();},handleProgressEvent=function(event,files,index,xhr,settings){var progressEvent=event;if(isChunkedUpload(settings)&&event.lengthComputable){progressEvent=createProgressEvent(true,settings.uploadedBytes+parseInt(event.loaded/event.total*settings.chunkSize,10),files[index].size);}
if(typeof settings.onProgress===func){settings.onProgress(progressEvent,files,index,xhr,settings);}
handleGlobalProgress(progressEvent,files,index,xhr,settings);},initUploadEventHandlers=function(files,index,xhr,settings){if(xhr.upload){xhr.upload.onprogress=function(e){handleProgressEvent(e,files,index,xhr,settings);};}
xhr.onload=function(e){handleLoadEvent(e,files,index,xhr,settings);};xhr.onabort=function(e){settings.progressTotal=settings.progressLoaded;if(typeof settings.onAbort===func){settings.onAbort(e,files,index,xhr,settings);}
completeNext();};xhr.onerror=function(e){settings.progressTotal=settings.progressLoaded;if(typeof settings.onError===func){settings.onError(e,files,index,xhr,settings);}
completeNext();};},getUrl=function(settings){if(typeof settings.url===func){return settings.url(settings.uploadForm||uploadForm);}
return settings.url;},getMethod=function(settings){if(typeof settings.method===func){return settings.method(settings.uploadForm||uploadForm);}
return settings.method;},getFieldName=function(settings){if(typeof settings.fieldName===func){return settings.fieldName(settings.fileInput||fileInput);}
return settings.fieldName;},getFormData=function(settings){var formData;if(typeof settings.formData===func){return settings.formData(settings.uploadForm||uploadForm);}else if($.isArray(settings.formData)){return settings.formData;}else if(settings.formData){formData=[];$.each(settings.formData,function(name,value){formData.push({name:name,value:value});});return formData;}
return[];},isSameDomain=function(url){if(protocolRegExp.test(url)){var host=location.host,indexStart=location.protocol.length+2,index=url.indexOf(host,indexStart),pathIndex=index+host.length;if((index===indexStart||index===url.indexOf('@',indexStart)+1)&&(url.length===pathIndex||$.inArray(url.charAt(pathIndex),['/','?','#'])!==-1)){return true;}
return false;}
return true;},initUploadRequest=function(files,index,xhr,settings){var file=files[index],url=getUrl(settings),sameDomain=isSameDomain(url);xhr.open(getMethod(settings),url,true);if(sameDomain){xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');if(!settings.multipart||isChunkedUpload(settings)){xhr.setRequestHeader('X-File-Name',file.name);xhr.setRequestHeader('X-File-Type',file.type);xhr.setRequestHeader('X-File-Size',file.size);if(!isChunkedUpload(settings)){xhr.setRequestHeader('Content-Type',file.type);}else if(!settings.multipart){xhr.setRequestHeader('Content-Type','application/octet-stream');}}}else if(settings.withCredentials){xhr.withCredentials=true;}
if($.isArray(settings.requestHeaders)){$.each(settings.requestHeaders,function(index,header){xhr.setRequestHeader(header.name,header.value);});}else if(settings.requestHeaders){$.each(settings.requestHeaders,function(name,value){xhr.setRequestHeader(name,value);});}},formDataUpload=function(files,xhr,settings){var formData=new FormData(),i;$.each(getFormData(settings),function(index,field){formData.append(field.name,field.value);});for(i=0;i<files.length;i+=1){formData.append(getFieldName(settings),files[i]);}
xhr.send(formData);},loadFileContent=function(file,callBack){file.reader=new FileReader();file.reader.onload=callBack;file.reader.readAsBinaryString(file);},utf8encode=function(str){return unescape(encodeURIComponent(str));},buildMultiPartFormData=function(boundary,files,filesFieldName,fields){var doubleDash='--',crlf='\r\n',formData='',buffer=[];$.each(fields,function(index,field){formData+=doubleDash+boundary+crlf+'Content-Disposition: form-data; name="'+
utf8encode(field.name)+'"'+crlf+crlf+
utf8encode(field.value)+crlf;});$.each(files,function(index,file){formData+=doubleDash+boundary+crlf+'Content-Disposition: form-data; name="'+
utf8encode(filesFieldName)+'"; filename="'+utf8encode(file.name)+'"'+crlf+'Content-Type: '+utf8encode(file.type)+crlf+crlf;buffer.push(formData);buffer.push(file.reader.result);delete file.reader;formData=crlf;});formData+=doubleDash+boundary+doubleDash+crlf;buffer.push(formData);return buffer.join('');},fileReaderUpload=function(files,xhr,settings){var boundary='----MultiPartFormBoundary'+(new Date()).getTime(),loader,i;xhr.setRequestHeader('Content-Type','multipart/form-data; boundary='+boundary);loader=new MultiLoader(function(){xhr.sendAsBinary(buildMultiPartFormData(boundary,files,getFieldName(settings),getFormData(settings)));},files.length);for(i=0;i<files.length;i+=1){loadFileContent(files[i],loader.complete);}},getBlob=function(file,settings){var blob,ub=settings.uploadedBytes,mcs=settings.maxChunkSize;if(file&&typeof file.slice===func&&(ub||(mcs&&mcs<file.size))){settings.uploadedBytes=ub=ub||0;blob=file.slice(ub,mcs||file.size-ub);settings.chunkSize=blob.size;return blob;}
return file;},upload=function(event,files,index,xhr,settings,nextChunk){var send;send=function(){if(!nextChunk){if(typeof settings.onSend===func&&settings.onSend(event,files,index,xhr,settings)===false){completeNext();return;}}
var blob=getBlob(files[index],settings),filesToUpload;initUploadEventHandlers(files,index,xhr,settings);initUploadRequest(files,index,xhr,settings);if(!settings.multipart){if(xhr.upload){xhr.send(blob);}else{$.error('Browser does not support XHR file uploads');}}else{filesToUpload=(typeof index==='number')?[blob]:files;if(typeof FormData!==undef){formDataUpload(filesToUpload,xhr,settings);}else if(typeof FileReader!==undef&&typeof xhr.sendAsBinary===func){fileReaderUpload(filesToUpload,xhr,settings);}else{$.error('Browser does not support multipart/form-data XHR file uploads');}}};if(!nextChunk){multiLoader.push(Array.prototype.slice.call(arguments,1));if(settings.sequentialUploads){sequenceHandler.push(send);return;}}
send();},handleUpload=function(event,files,input,form,index){var xhr=new XMLHttpRequest(),uploadSettings=$.extend({},settings);uploadSettings.fileInput=input;uploadSettings.uploadForm=form;if(typeof uploadSettings.initUpload===func){uploadSettings.initUpload(event,files,index,xhr,uploadSettings,function(){upload(event,files,index,xhr,uploadSettings);});}else{upload(event,files,index,xhr,uploadSettings);}},handleLegacyGlobalProgress=function(event,files,index,iframe,settings){var total=0,progressEvent;if(typeof index===undef){$.each(files,function(index,file){total+=file.size?file.size:1;});}else{total=files[index].size?files[index].size:1;}
progressEvent=createProgressEvent(true,total,total);settings.progressLoaded=total;handleGlobalProgress(progressEvent,files,index,iframe,settings);},legacyUploadFormDataInit=function(input,form,settings){var formData=getFormData(settings);form.find(':input').not(':disabled').prop('disabled',true).addClass(settings.namespace+'_disabled');$.each(formData,function(index,field){$('<input type="hidden"/>').attr('name',field.name).val(field.value).addClass(settings.namespace+'_form_data').appendTo(form);});input.attr('name',getFieldName(settings)).appendTo(form);},legacyUploadFormDataReset=function(input,form,settings){input.detach();form.find('.'+settings.namespace+'_disabled').prop('disabled',false).removeClass(settings.namespace+'_disabled');form.find('.'+settings.namespace+'_form_data').remove();},legacyUpload=function(event,files,input,form,iframe,settings,index){var send;send=function(){if(typeof settings.onSend===func&&settings.onSend(event,files,index,iframe,settings)===false){completeNext();return;}
var originalAttributes={'action':form.attr('action'),'method':form.attr('method'),'target':form.attr('target'),'enctype':form.attr('enctype')};iframe.unbind('abort').bind('abort',function(e){iframe.readyState=0;iframe.unbind('load').attr('src','javascript'.concat(':false;'));handleLegacyGlobalProgress(e,files,index,iframe,settings);if(typeof settings.onAbort===func){settings.onAbort(e,files,index,iframe,settings);}
completeNext();}).unbind('load').bind('load',function(e){iframe.readyState=4;handleLegacyGlobalProgress(e,files,index,iframe,settings);if(typeof settings.onLoad===func){settings.onLoad(e,files,index,iframe,settings);}
$('<iframe src="javascript:false;" style="display:none;"></iframe>').appendTo(form).remove();completeNext();});form.attr('action',getUrl(settings)).attr('method',getMethod(settings)).attr('target',iframe.attr('name')).attr('enctype','multipart/form-data');legacyUploadFormDataInit(input,form,settings);iframe.readyState=2;form.get(0).submit();legacyUploadFormDataReset(input,form,settings);$.each(originalAttributes,function(name,value){if(value){form.attr(name,value);}else{form.removeAttr(name);}});};multiLoader.push([files,index,iframe,settings]);if(settings.sequentialUploads){sequenceHandler.push(send);}else{send();}},normalizeFile=function(index,file){if(typeof file.name===undef&&typeof file.size===undef){file.name=file.fileName;file.size=file.fileSize;}},handleLegacyUpload=function(event,input,form,index){if(!(event&&input&&form)){$.error('Iframe based File Upload requires a file input change event');return;}
var iframe=$('<iframe src="javascript:false;" style="display:none;" name="iframe_'+
settings.namespace+'_'+(new Date()).getTime()+'"></iframe>'),uploadSettings=$.extend({},settings),files=event.target&&event.target.files;files=files?Array.prototype.slice.call(files,0):[{name:input.val(),type:null,size:null}];$.each(files,normalizeFile);index=files.length===1?0:index;uploadSettings.fileInput=input;uploadSettings.uploadForm=form;iframe.readyState=0;iframe.abort=function(){iframe.trigger('abort');};iframe.bind('load',function(){iframe.unbind('load');if(typeof uploadSettings.initUpload===func){uploadSettings.initUpload(event,files,index,iframe,uploadSettings,function(){legacyUpload(event,files,input,form,iframe,uploadSettings,index);});}else{legacyUpload(event,files,input,form,iframe,uploadSettings,index);}}).appendTo(form);},canHandleXHRUploadSize=function(files){var bytes=0,totalBytes=0,i;if(settings.multipart&&typeof FormData===undef){for(i=0;i<files.length;i+=1){bytes=files[i].size;if(bytes>settings.maxFileReaderSize){return false;}
totalBytes+=bytes;}
if(settings.multiFileRequest&&totalBytes>settings.maxFileReaderSize){return false;}}
return true;},handleFiles=function(event,files,input,form){if(!canHandleXHRUploadSize(files)){handleLegacyUpload(event,input,form);return;}
var i;files=Array.prototype.slice.call(files,0);$.each(files,normalizeFile);if(settings.multiFileRequest&&settings.multipart&&files.length){handleUpload(event,files,input,form);}else{for(i=0;i<files.length;i+=1){handleUpload(event,files,input,form,i);}}},initUploadForm=function(){uploadForm=(container.is('form')?container:container.find('form')).filter(settings.uploadFormFilter);},initFileInput=function(){fileInput=(uploadForm.length?uploadForm:container).find('input:file').filter(settings.fileInputFilter);},replaceFileInput=function(input){var inputClone=input.clone(true);$('<form/>').append(inputClone).get(0).reset();input.after(inputClone).detach();initFileInput();};this.onDocumentDragOver=function(e){if(typeof settings.onDocumentDragOver===func&&settings.onDocumentDragOver(e)===false){return false;}
e.preventDefault();};this.onDocumentDrop=function(e){if(typeof settings.onDocumentDrop===func&&settings.onDocumentDrop(e)===false){return false;}
e.preventDefault();};this.onDragOver=function(e){if(typeof settings.onDragOver===func&&settings.onDragOver(e)===false){return false;}
var dataTransfer=e.originalEvent.dataTransfer;if(dataTransfer&&dataTransfer.files){dataTransfer.dropEffect=dataTransfer.effectAllowed='copy';e.preventDefault();}};this.onDrop=function(e){if(typeof settings.onDrop===func&&settings.onDrop(e)===false){return false;}
var dataTransfer=e.originalEvent.dataTransfer;if(dataTransfer&&dataTransfer.files&&isXHRUploadCapable()){handleFiles(e,dataTransfer.files);}
e.preventDefault();};this.onChange=function(e){if(typeof settings.onChange===func&&settings.onChange(e)===false){return false;}
var input=$(e.target),form=$(e.target.form);if(form.length===1){if(settings.replaceFileInput){input.data(defaultNamespace+'_form',form);replaceFileInput(input);}}else{form=input.data(defaultNamespace+'_form');}
if(!settings.forceIframeUpload&&e.target.files&&isXHRUploadCapable()){handleFiles(e,e.target.files,input,form);}else{handleLegacyUpload(e,input,form);}};this.init=function(options){if(options){$.extend(settings,options);optionsReference=options;}
initUploadForm();initFileInput();if(container.data(settings.namespace)){$.error('FileUpload with namespace "'+settings.namespace+'" already assigned to this element');return;}
container.data(settings.namespace,fileUpload).addClass(settings.cssClass);settings.dropZone.not(container).addClass(settings.cssClass);initEventHandlers();if(typeof settings.init===func){settings.init();}};this.options=function(options){var oldCssClass,oldDropZone,uploadFormFilterUpdate,fileInputFilterUpdate;if(typeof options===undef){return $.extend({},settings);}
if(optionsReference){$.extend(optionsReference,options);}
removeEventHandlers();$.each(options,function(name,value){switch(name){case'namespace':$.error('The FileUpload namespace cannot be updated.');return;case'uploadFormFilter':uploadFormFilterUpdate=true;fileInputFilterUpdate=true;break;case'fileInputFilter':fileInputFilterUpdate=true;break;case'cssClass':oldCssClass=settings.cssClass;break;case'dropZone':oldDropZone=settings.dropZone;break;}
settings[name]=value;});if(uploadFormFilterUpdate){initUploadForm();}
if(fileInputFilterUpdate){initFileInput();}
if(typeof oldCssClass!==undef){container.removeClass(oldCssClass).addClass(settings.cssClass);(oldDropZone?oldDropZone:settings.dropZone).not(container).removeClass(oldCssClass);settings.dropZone.not(container).addClass(settings.cssClass);}else if(oldDropZone){oldDropZone.not(container).removeClass(settings.cssClass);settings.dropZone.not(container).addClass(settings.cssClass);}
initEventHandlers();};this.option=function(name,value){var options;if(typeof value===undef){return settings[name];}
options={};options[name]=value;fileUpload.options(options);};this.destroy=function(){if(typeof settings.destroy===func){settings.destroy();}
removeEventHandlers();container.removeData(settings.namespace).removeClass(settings.cssClass);settings.dropZone.not(container).removeClass(settings.cssClass);};this.upload=function(files){if(typeof files.length===undef){files=[files];}
handleFiles(null,files);};};methods={init:function(options){return this.each(function(){(new FileUpload($(this))).init(options);});},option:function(option,value,namespace){namespace=namespace?namespace:defaultNamespace;var fileUpload=$(this).data(namespace);if(fileUpload){if(!option){return fileUpload.options();}else if(typeof option==='string'&&typeof value===undef){return fileUpload.option(option);}}else{$.error('No FileUpload with namespace "'+namespace+'" assigned to this element');}
return this.each(function(){var fu=$(this).data(namespace);if(fu){if(typeof option==='string'){fu.option(option,value);}else{fu.options(option);}}else{$.error('No FileUpload with namespace "'+namespace+'" assigned to this element');}});},destroy:function(namespace){namespace=namespace?namespace:defaultNamespace;return this.each(function(){var fileUpload=$(this).data(namespace);if(fileUpload){fileUpload.destroy();}else{$.error('No FileUpload with namespace "'+namespace+'" assigned to this element');}});},upload:function(files,namespace){namespace=namespace?namespace:defaultNamespace;return this.each(function(){var fileUpload=$(this).data(namespace);if(fileUpload){fileUpload.upload(files);}else{$.error('No FileUpload with namespace "'+namespace+'" assigned to this element');}});}};$.fn.fileUpload=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1));}else if(typeof method==='object'||!method){return methods.init.apply(this,arguments);}else{$.error('Method "'+method+'" does not exist on jQuery.fileUpload');}};}(jQuery));
(function($){'use strict';var undef='undefined',func='function',UploadHandler,methods,MultiLoader=function(callBack){var loaded=0,list=[];this.complete=function(){loaded+=1;if(loaded===list.length+1){callBack(list);loaded=0;list=[];}};this.push=function(item){list.push(item);};this.getList=function(){return list;};};UploadHandler=function(container,options){var uploadHandler=this,dragOverTimeout,isDropZoneEnlarged,multiLoader=new MultiLoader(function(list){uploadHandler.hideProgressBarAll(function(){uploadHandler.resetProgressBarAll();if(typeof uploadHandler.onCompleteAll===func){uploadHandler.onCompleteAll(list);}});}),getUploadTable=function(handler){return typeof handler.uploadTable===func?handler.uploadTable(handler):handler.uploadTable;},getDownloadTable=function(handler){return typeof handler.downloadTable===func?handler.downloadTable(handler):handler.downloadTable;};this.requestHeaders={'Accept':'application/json, text/javascript, */*; q=0.01'};this.dropZone=container;this.imageTypes=/^image\/(gif|jpeg|png)$/;this.previewMaxWidth=this.previewMaxHeight=120;this.previewLoadDelay=100;this.previewAsCanvas=true;this.previewSelector='.file_upload_preview';this.progressSelector='.file_upload_progress div';this.cancelSelector='.file_upload_cancel button';this.cssClassSmall='file_upload_small';this.cssClassLarge='file_upload_large';this.cssClassHighlight='file_upload_highlight';this.dropEffect='highlight';this.uploadTable=this.downloadTable=null;this.buildUploadRow=this.buildDownloadRow=null;this.progressAllNode=null;this.maxFiles=0;this.currentFileCount=0;this.loadImage=function(file,callBack,maxWidth,maxHeight,imageTypes,noCanvas){var img,scaleImage,urlAPI,fileReader;if(imageTypes&&!imageTypes.test(file.type)){return null;}
scaleImage=function(img){var canvas=document.createElement('canvas'),scale=Math.min((maxWidth||img.width)/img.width,(maxHeight||img.height)/img.height);if(scale>1){scale=1;}
img.width=parseInt(img.width*scale,10);img.height=parseInt(img.height*scale,10);if(noCanvas||typeof canvas.getContext!==func){return img;}
canvas.width=img.width;canvas.height=img.height;canvas.getContext('2d').drawImage(img,0,0,img.width,img.height);return canvas;};img=document.createElement('img');urlAPI=typeof URL!==undef?URL:typeof webkitURL!==undef?webkitURL:null;if(urlAPI&&typeof urlAPI.createObjectURL===func){img.onload=function(){urlAPI.revokeObjectURL(this.src);callBack(scaleImage(img));};img.src=urlAPI.createObjectURL(file);}else if(typeof FileReader!==undef&&typeof FileReader.prototype.readAsDataURL===func){img.onload=function(){callBack(scaleImage(img));};fileReader=new FileReader();fileReader.onload=function(e){img.src=e.target.result;};fileReader.readAsDataURL(file);}else{callBack(null);}};this.addNode=function(parentNode,node,callBack){if(parentNode&&parentNode.length&&node&&node.length){node.css('display','none').appendTo(parentNode).fadeIn(function(){if(typeof callBack===func){try{callBack();}catch(e){node.stop();throw e;}}});}else if(typeof callBack===func){callBack();}};this.removeNode=function(node,callBack){if(node&&node.length){node.fadeOut(function(){node.remove();if(typeof callBack===func){try{callBack();}catch(e){node.stop();throw e;}}});}else if(typeof callBack===func){callBack();}};this.replaceNode=function(oldNode,newNode,callBack){if(!(newNode&&newNode.length)){return uploadHandler.removeNode(oldNode,callBack);}
if(oldNode&&oldNode.length){oldNode.fadeOut(function(){newNode.css('display','none');oldNode.replaceWith(newNode);newNode.fadeIn(function(){if(typeof callBack===func){try{callBack();}catch(e){oldNode.stop();newNode.stop();throw e;}}});});}else if(typeof callBack===func){callBack();}};this.resetProgressBarAll=function(){if(uploadHandler.progressbarAll){uploadHandler.progressbarAll.progressbar('value',0);}};this.hideProgressBarAll=function(callBack){if(uploadHandler.progressbarAll&&!$(getUploadTable(uploadHandler)).find(uploadHandler.progressSelector+':visible:first').length){uploadHandler.progressbarAll.fadeOut(callBack);}else if(typeof callBack===func){callBack();}};this.onAbort=function(event,files,index,xhr,handler){handler.removeNode(handler.uploadRow,handler.hideProgressBarAll);};this.cancelUpload=function(event,files,index,xhr,handler){var readyState=xhr.readyState;xhr.abort();if(typeof readyState!=='number'||readyState<2){handler.onAbort(event,files,index,xhr,handler);}
uploadHandler.currentFileCount=uploadHandler.currentFileCount>0?uploadHandler.currentFileCount-1:0;};this.initProgressBar=function(node,value){if(!node||!node.length){return null;}
if(typeof node.progressbar===func){return node.progressbar({value:value});}else{node.addClass('progressbar').append($('<div/>').css('width',value+'%')).progressbar=function(key,value){return this.each(function(){if(key==='destroy'){$(this).removeClass('progressbar').empty();}else{$(this).children().css('width',value+'%');}});};return node;}};this.destroyProgressBar=function(node){if(!node||!node.length){return null;}
return node.progressbar('destroy');};this.initUploadProgress=function(xhr,handler){if(!xhr.upload&&handler.progressbar){handler.progressbar.progressbar('value',100);}};this.initUploadProgressAll=function(){if(uploadHandler.progressbarAll&&uploadHandler.progressbarAll.is(':hidden')){uploadHandler.progressbarAll.fadeIn();}};this.onSend=function(event,files,index,xhr,handler){handler.initUploadProgress(xhr,handler);};this.onProgress=function(event,files,index,xhr,handler){if(handler.progressbar&&event.lengthComputable){handler.progressbar.progressbar('value',parseInt(event.loaded/event.total*100,10));}};this.onProgressAll=function(event,list){if(uploadHandler.progressbarAll&&event.lengthComputable){uploadHandler.progressbarAll.progressbar('value',parseInt(event.loaded/event.total*100,10));}};this.onLoadAll=function(list){multiLoader.complete();};this.initProgressBarAll=function(){if(!uploadHandler.progressbarAll){uploadHandler.progressbarAll=uploadHandler.initProgressBar((typeof uploadHandler.progressAllNode===func?uploadHandler.progressAllNode(uploadHandler):uploadHandler.progressAllNode),0);}};this.destroyProgressBarAll=function(){uploadHandler.destroyProgressBar(uploadHandler.progressbarAll);};this.loadPreviewImage=function(files,index,handler){index=index||0;handler.uploadRow.find(handler.previewSelector).each(function(){var previewNode=$(this),file=files[index];setTimeout(function(){handler.loadImage(file,function(img){handler.addNode(previewNode,$(img));},handler.previewMaxWidth,handler.previewMaxHeight,handler.imageTypes,!handler.previewAsCanvas);},handler.previewLoadDelay);index+=1;});};this.initUploadRow=function(event,files,index,xhr,handler){var uploadRow=false;if(uploadHandler.maxFiles==0||(uploadHandler.currentFileCount<uploadHandler.maxFiles&&(uploadHandler.currentFileCount+files.length)<=uploadHandler.maxFiles))
{uploadRow=handler.uploadRow=(typeof handler.buildUploadRow===func?handler.buildUploadRow(files,index,handler):null);uploadHandler.currentFileCount++;}
if(uploadRow){handler.progressbar=handler.initProgressBar(uploadRow.find(handler.progressSelector),0);uploadRow.find(handler.cancelSelector).click(function(e){handler.cancelUpload(e,files,index,xhr,handler);e.preventDefault();});handler.loadPreviewImage(files,index,handler);}};this.initUpload=function(event,files,index,xhr,handler,callBack){handler.initUploadRow(event,files,index,xhr,handler);handler.addNode(getUploadTable(handler),handler.uploadRow,function(){if(typeof handler.beforeSend===func){handler.beforeSend(event,files,index,xhr,handler,callBack);}else{callBack();}});handler.initUploadProgressAll();};this.parseResponse=function(xhr,handler){if(typeof xhr.responseText!==undef){return $.parseJSON(xhr.responseText);}else{return $.parseJSON(xhr.contents().text());}};this.initDownloadRow=function(event,files,index,xhr,handler){var json,downloadRow;try{json=handler.response=handler.parseResponse(xhr,handler);}catch(e){if(typeof handler.onError===func){handler.originalEvent=event;handler.onError(e,files,index,xhr,handler);}else{throw e;}}
downloadRow=handler.downloadRow=(typeof handler.buildDownloadRow===func?handler.buildDownloadRow(json,handler):null);};this.onLoad=function(event,files,index,xhr,handler){var uploadTable=getUploadTable(handler),downloadTable=getDownloadTable(handler),callBack=function(){if(typeof handler.onComplete===func){handler.onComplete(event,files,index,xhr,handler);}
multiLoader.complete();};multiLoader.push(Array.prototype.slice.call(arguments,1));handler.initDownloadRow(event,files,index,xhr,handler);if(uploadTable&&handler.uploadRow&&handler.uploadRow.length&&(!downloadTable||uploadTable.get(0)===downloadTable.get(0))){handler.replaceNode(handler.uploadRow,handler.downloadRow,callBack);}else{handler.removeNode(handler.uploadRow,function(){handler.addNode(downloadTable,handler.downloadRow,callBack);});}};this.dropZoneEnlarge=function(){if(!isDropZoneEnlarged){if(typeof uploadHandler.dropZone.switchClass===func){uploadHandler.dropZone.switchClass(uploadHandler.cssClassSmall,uploadHandler.cssClassLarge);}else{uploadHandler.dropZone.addClass(uploadHandler.cssClassLarge);uploadHandler.dropZone.removeClass(uploadHandler.cssClassSmall);}
isDropZoneEnlarged=true;}};this.dropZoneReduce=function(){if(typeof uploadHandler.dropZone.switchClass===func){uploadHandler.dropZone.switchClass(uploadHandler.cssClassLarge,uploadHandler.cssClassSmall);}else{uploadHandler.dropZone.addClass(uploadHandler.cssClassSmall);uploadHandler.dropZone.removeClass(uploadHandler.cssClassLarge);}
isDropZoneEnlarged=false;};this.onDocumentDragEnter=function(event){uploadHandler.dropZoneEnlarge();};this.onDocumentDragOver=function(event){if(dragOverTimeout){clearTimeout(dragOverTimeout);}
dragOverTimeout=setTimeout(function(){uploadHandler.dropZoneReduce();},200);};this.onDragEnter=this.onDragLeave=function(event){uploadHandler.dropZone.toggleClass(uploadHandler.cssClassHighlight);};this.onDrop=function(event){if(dragOverTimeout){clearTimeout(dragOverTimeout);}
if(uploadHandler.dropEffect&&typeof uploadHandler.dropZone.effect===func){uploadHandler.dropZone.effect(uploadHandler.dropEffect,function(){uploadHandler.dropZone.removeClass(uploadHandler.cssClassHighlight);uploadHandler.dropZoneReduce();});}else{uploadHandler.dropZone.removeClass(uploadHandler.cssClassHighlight);uploadHandler.dropZoneReduce();}};this.init=function(){uploadHandler.initProgressBarAll();if(typeof uploadHandler.initExtended===func){uploadHandler.initExtended();}};this.destroy=function(){if(typeof uploadHandler.destroyExtended===func){uploadHandler.destroyExtended();}
uploadHandler.destroyProgressBarAll();};$.extend(this,options);};methods={init:function(options){return this.each(function(){$(this).fileUpload(new UploadHandler($(this),options));});},option:function(option,value,namespace){if(!option||(typeof option==='string'&&typeof value===undef)){return $(this).fileUpload('option',option,value,namespace);}
return this.each(function(){$(this).fileUpload('option',option,value,namespace);});},destroy:function(namespace){return this.each(function(){$(this).fileUpload('destroy',namespace);});},upload:function(files,namespace){return this.each(function(){$(this).fileUpload('upload',files,namespace);});}};$.fn.fileUploadUI=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1));}else if(typeof method==='object'||!method){return methods.init.apply(this,arguments);}else{$.error('Method "'+method+'" does not exist on jQuery.fileUploadUI');}};}(jQuery));
jQuery(function($){var $search_results,$folders_center,$item_details;pyro.files.cache={};pyro.files.history={};pyro.files.timeout={};pyro.files.current_level=0;$('.files-tooltip').tipsy({gravity:'n',fade:true,html:true,live:true,delayIn:800,delayOut:300,title:function(){var text=$(this).find('span').html();if(text.length>15){return text;}
return'';}});$('.item .folders-center').trigger('click');$(window).on('show-message',function(e,results){if(typeof(results.message)!=="undefined"&&results.message>''){var li_status_class='info',status_class='icon-info-sign';switch(results.status){case true:li_status_class='success';status_class='icon-ok-sign';break;case false:li_status_class='failure';status_class='icon-remove-sign';break;}
$('#activity').find('span').fadeOut();$('#activity').html('<span class="'+li_status_class+'"><i class="'+status_class+'"></i> '+results.message+'</span>');}});$search_results=$('ul#search-results');$('.sidebar-right').find('.close').on('click',function(){$search_results.empty();$('.sidebar-right').removeClass('fadeInRight').addClass('fadeOutRight');$('.side, .center').removeClass('three_column');});$('input#file-search').keyup(function(e){$search_results.empty();if(e.which===13){$.post(SITE_URL+'admin/files/search',{search:$(e.target).val()},function(data){var results=$.parseJSON(data);if(results.status){$.each(results.data,function(type,item){if(item.length>0){$.each(item,function(i,result){$('<li>'+'<div class="'+type+'"></div>'+'<a data-parent="'+(type==='folder'?result.parent_id:result.folder_id)+'" href="'+SITE_URL+'admin/files#">'+result.name+'</a>'+'</li>').appendTo('ul#search-results');});}});}else{$('<li><div class="info"></div>'+results.message+'</li>').appendTo('ul#search-results');}
$('.sidebar-right').show().removeClass('fadeOutRight').addClass('fadeInRight');$('.side, .center').addClass('three_column');});}});$search_results.on('click','a',function(e){e.preventDefault();var $el=$(this),id=$el.attr('data-parent'),text=$el.html();pyro.files.folder_contents(id);$(window).on('load-completed',function(e,results){$('.folders-center').find('li').removeClass('selected');$('.folders-center').find('[data-name="'+text+'"]').addClass('selected');});});$folders_center=$('.folders-center');$folders_center.on('dblclick','.folder',function(e){pyro.files.$last_r_click=$(e.target).closest('li');$('.context-menu-source [data-menu="open"]').trigger('click');});$('ul#folders-sidebar').find('li').has('ul').addClass('open');$('ul#folders-sidebar').on('click','.folder',function(e){e.preventDefault();e.stopPropagation();var $clicked=$(e.target);if($clicked.is('a')){pyro.files.$last_r_click=$clicked.parent('li');$('.context-menu-source [data-menu="open"]').trigger('click');}else{$clicked.parent('li').toggleClass('open close').children('ul').slideToggle(50);}});$('#file-breadcrumbs').on('click','a',function(e){e.preventDefault();e.stopPropagation();pyro.files.$last_r_click=$(e.target);$('.context-menu-source [data-menu="open"]').trigger('click');});$('.item').on('contextmenu click','.folders-center, .folders-center li',function(e){e.preventDefault();e.stopPropagation();pyro.files.$last_r_click=$(this);var $menu_sources=$('.context-menu-source, .button-menu-source');var $context_menu_source=$('.context-menu-source');var $button_menu_source=$('.button-menu-source');$button_menu_source.fadeIn();$menu_sources.find('li').show().filter(function(index){var folder,pattern=new RegExp('pane'),$target=$(e.target).is('span')?$(e.target).parent('li'):$(e.target);if($target.hasClass('file')||$target.is('img')){pattern=new RegExp('file');}else if($target.hasClass('folder')){pattern=new RegExp('folder');folder=true;}else if($target.hasClass('pane')&&pyro.files.current_level=='0'){pattern=new RegExp('root-pane');}
if(!pattern.test($(this).attr('data-applies-to'))){$(this).hide();}
if($(this).attr('data-role')&&pyro.files.has_permissions($(this).attr('data-role'))===false){$(this).hide();}
if(folder&&$(this).attr('data-role')==='synchronize'){$item=$(window).data('folder_'+pyro.files.$last_r_click.attr('data-id'));if($item.location==='local'){$(this).hide();}}});if($(e.target).hasClass('folder'))
{$('.folders-center li.selected').removeClass('selected');$(e.target).addClass('highlight');}
else
{$('.folders-center li.highlight').removeClass('highlight');}
if(e.type=='contextmenu')
{$('.tipsy').remove();$context_menu_source.fadeIn('fast').position({my:'left top',at:'left bottom',of:e,collision:'fit'});}
else
{$context_menu_source.hide();}});$('.context-menu-source, .button-menu-source').on('click','[data-menu]',function(e){var menu=$(this).attr('data-menu'),item;switch(menu){case'open':pyro.files.folder_contents(pyro.files.$last_r_click.attr('data-id'));break;case'upload':$(window).trigger('open-upload');break;case'new-folder':$('.no_data').fadeOut(100);setTimeout(function(){pyro.files.new_folder(pyro.files.current_level);},150);break;case'rename':pyro.files.rename();break;case'download':$item=$(window).data('file_'+pyro.files.$last_r_click.attr('data-id'));if($item.type==='i'&&$item.location!=='local'){window.open(SITE_URL+'files/download/'+$item.id);}else{window.location=SITE_URL+'files/download/'+$item.id;}
break;case'synchronize':pyro.files.synchronize();break;case'delete':if(!confirm(pyro.lang.dialog_message)){return;}
pyro.files.delete_item(pyro.files.current_level);$('.item .folders-center').trigger('click');break;case'replace':pyro.files.replace();break;case'details':pyro.files.details();break;case'refresh':pyro.files.folder_contents(pyro.files.current_level);break;}});$folders_center.on('click','.file[data-id]',function(e){var first,last,$selected_files=$folders_center.find('.selected');if(!e.ctrlKey&&!e.shiftKey){if($selected_files.length>0){$('[data-id]').removeClass('selected');}}
$(this).toggleClass('selected');if(e.shiftKey){$folders_center.find('.selected').last().prevAll('.selected:first ~ *').addClass('selected');}});$('html').on('click',function(e){$folders_center.find('li').removeClass('selected');$('.context-menu-source').fadeOut('fast');});$folders_center.sortable({cursor:'move',delay:100,update:function(e){var order={'folder':{},'file':{}};$(this).find('li').each(function(index,data){var type=$(data).hasClass('folder')?'folder':'file';order[type][index]=$(this).attr('data-id');});$.post(SITE_URL+'admin/files/order',{order:order},function(data){var results=$.parseJSON(data),after_id,moved;if(results.status){after_id=$(e.target).prevAll('li.folder').attr('data-id');moved='[data-id="'+$(e.target).attr('data-id')+'"]';if(after_id===undefined&&$(moved).parent().is('.folders-sidebar')){$('ul#folders-sidebar [data-id="0"]').after($('ul#folders-sidebar '+moved));}else if(after_id===undefined&&$(moved).parent().is('ul')){$('ul#folders-sidebar '+moved).parent('ul').prepend($('ul#folders-sidebar '+moved));}else{$('ul#folders-sidebar [data-id="'+after_id+'"]').after($('ul#folders-sidebar '+moved));}}
$(window).trigger('show-message',results);});}});$(window).on('open-upload',function(){var folder;if(!pyro.files.$last_r_click.hasClass('file')&&pyro.files.$last_r_click.attr('data-id')>''){pyro.files.upload_to=pyro.files.$last_r_click.attr('data-id');}else{pyro.files.upload_to=pyro.files.current_level;}
folder=$(window).data('folder_'+pyro.files.upload_to);$.colorbox({scrolling:false,inline:true,href:'#files-uploader',width:'920',height:'80%',opacity:0.3,onComplete:function(){$('#files-uploader-queue').empty();$.colorbox.resize();},onCleanup:function(){if(pyro.files.upload_to===pyro.files.current_level){pyro.files.folder_contents(pyro.files.upload_to);}
$('#files-uploader').find('form').fileUploadUI('option','maxFiles',0);$('#files-uploader').find('form').fileUploadUI('option','currentFileCount',0);$("#file-to-replace").hide();},onLoad:function(){if(!'mode'in pyro.files||pyro.files.mode!='replace'){return;}
if(pyro.files.$last_r_click.hasClass('file'))
{$("#file-to-replace").find('span.name').text(pyro.files.$last_r_click.attr('data-name')).end().show();$('#files-uploader').find('form').fileUploadUI('option','maxFiles',1);}}});});pyro.init_upload=function($form){$form.find('form').fileUploadUI({fieldName:'file',uploadTable:$('#files-uploader-queue'),downloadTable:$('#files-uploader-queue'),previewSelector:'.file_upload_preview div',cancelSelector:'.file_upload_cancel div.cancel-icon',buildUploadRow:function(files,index,handler){var resize='',type=files[index]['type'];if(type&&type.search('image')>=0){resize='<label id="width">'+pyro.lang.width+'</label>'+'<select name="width" class="skip"><option value="0">'+pyro.lang.full_size+'</option><option value="100">100px</option><option value="200">200px</option><option value="300">300px</option><option value="400">400px</option><option value="500">500px</option><option value="600">600px</option><option value="700">700px</option><option value="800">800px</option><option value="900">900px</option><option value="1000">1000px</option><option value="1100">1100px</option><option value="1200">1200px</option><option value="1300">1300px</option><option value="1400">1400px</option><option value="1500">1500px</option><option value="1600">1600px</option><option value="1700">1700px</option><option value="1800">1800px</option><option value="1900">1900px</option><option value="2000">2000px</option></select>'+'<label id="height">'+pyro.lang.height+'</label>'+'<select name="height" class="skip"><option value="0">'+pyro.lang.full_size+'</option><option value="100">100px</option><option value="200">200px</option><option value="300">300px</option><option value="400">400px</option><option value="500">500px</option><option value="600">600px</option><option value="700">700px</option><option value="800">800px</option><option value="900">900px</option><option value="1000">1000px</option><option value="1100">1100px</option><option value="1200">1200px</option><option value="1300">1300px</option><option value="1400">1400px</option><option value="1500">1500px</option><option value="1600">1600px</option><option value="1700">1700px</option><option value="1800">1800px</option><option value="1900">1900px</option><option value="2000">2000px</option></select>'+'<label id="ratio">'+pyro.lang.ratio+'</label>'+'<input name="ratio" type="checkbox" value="1" checked="checked"/>'+'<label id="alt">'+pyro.lang.alt_attribute+'</label>'+'<input type="text" name="alt_attribute" class="alt_attribute" />';}
return $('<li>'+'<div class="file_upload_preview ui-corner-all"><div class="ui-corner-all preview-container"></div></div>'+'<div class="filename"><label for="file-name">'+files[index].name+'</label>'+'<input class="file-name" type="hidden" name="name" value="'+files[index].name+'" />'+'</div>'+'<div class="file_upload_progress"><div></div></div>'+'<div class="file_upload_cancel">'+'<div title="'+pyro.lang.start+'" class="start-icon ui-helper-hidden-accessible"></div>'+'<div title="'+pyro.lang.cancel+'" class="cancel-icon"></div>'+'</div>'+'<div class="image_meta">'+
resize+'</div>'+'</li>');},buildDownloadRow:function(results){if(results.message)
{$(window).trigger('show-message',results);}},beforeSend:function(event,files,index,xhr,handler,callBack){if(!handler.uploadRow)
{return;}
var $progress_div=handler.uploadRow.find('.file_upload_progress'),regexp;if(files[index].size>pyro.files.max_size_possible){$progress_div.html(pyro.lang.exceeds_server_setting);return false;}else if(files[index].size>pyro.files.max_size_allowed){$progress_div.html(pyro.lang.exceeds_allowed);return false;}
regexp=new RegExp('\\.('+pyro.files.valid_extensions+')$','i');if(!regexp.test(files[index].name.toLowerCase())){$progress_div.html(pyro.lang.file_type_not_allowed);return false;}
handler.uploadRow.find('div.start-icon').on('click',function(){handler.formData={name:handler.uploadRow.find('input.file-name').val(),width:handler.uploadRow.find('[name="width"]').val(),height:handler.uploadRow.find('[name="height"]').val(),ratio:handler.uploadRow.find('[name="ratio"]').is(':checked'),alt_attribute:handler.uploadRow.find('[name="alt_attribute"]').val(),folder_id:pyro.files.upload_to,replace_id:'mode'in pyro.files&&pyro.files.mode=='replace'?pyro.files.$last_r_click.attr('data-id'):0,csrf_hash_name:$.cookie(pyro.csrf_cookie_name)};callBack();});},onComplete:function(event,files,index,xhr,handler){if(files.length===index+1){$('#files-uploader a.cancel-upload').click();}}});$form.on('click','.start-upload',function(e){e.preventDefault();$('#files-uploader-queue div.start-icon').click();});$form.on('click','.cancel-upload',function(e){e.preventDefault();$('#files-uploader-queue div.cancel-icon').click();$.colorbox.close();});};pyro.init_upload($('#files-uploader'));pyro.files.new_folder=function(parent,name){var new_class=Math.floor(Math.random()*1000),post_data;if(typeof(name)==='undefined'){name=pyro.lang.new_folder_name;}
$('.new-folder').clone().removeClass('new-folder').appendTo('.folders-center').addClass('folder folder-'+new_class);post_data={parent:parent,name:name};$.post(SITE_URL+'admin/files/new_folder',post_data,function(data){var results=$.parseJSON(data);if(results.status){$('.folder-'+new_class).attr('data-id',results.data.id);$('.folder-'+new_class+' .name-text').html(results.data.name).removeClass('folder-'+new_class);$parent_li=$('ul#folders-sidebar .folder[data-id="'+parent+'"]');if(parent===0||$parent_li.hasClass('places')){$parent_li.after('<li class="folder" data-id="'+results.data.id+'" data-name="'+results.data.name+'"><div></div><a href="#">'+results.data.name+'</a></li>');}else if($parent_li.has('ul').length>0){$parent_li.children('ul').append('<li class="folder" data-id="'+results.data.id+'" data-name="'+results.data.name+'"><div></div><a href="#">'+results.data.name+'</a></li>');}else{$parent_li.append('<ul style="display:block"><li class="folder" data-id="'+results.data.id+'" data-name="'+results.data.name+'"><div></div><a href="#">'+results.data.name+'</a></li></ul>');$parent_li.addClass('close');}
$(window).data('folder_'+results.data.id,results.data);pyro.files.$last_r_click=$('.folder[data-id="'+results.data.id+'"]');$('.context-menu-source [data-menu="rename"]').trigger('click');$(window).trigger('show-message',results);}});};pyro.files.folder_contents=function(folder_id){var level=pyro.files.current_level,folders=[],files=[],post_data,i=0,items=[],content_interval,current;$(window).trigger('show-message',{message:pyro.lang.fetching});post_data={parent:folder_id};$.post(SITE_URL+'admin/files/folder_contents',post_data,function(data){var results=$.parseJSON(data);if(results.status){$folders_center.find('li').each(function(index){var folder={},file={};if($(this).hasClass('folder')){folder.id=$(this).attr('data-id');folder.name=$(this).attr('data-name');folders[index]=folder;}else{file.id=$(this).attr('data-id');file.name=$(this).attr('data-name');files[index]=file;}});pyro.files.history[level]={folder:folders,file:files};$('.folders-center').find('li').fadeOut('fast').remove();$('.tipsy').remove();folder_id=results.data.parent_id;delete(results.data.parent_id);$.each(results.data,function(type,data){$.each(data,function(index,item){item.el_type=type;items.push(item);});});content_interval=window.setInterval(function(){if(typeof(items[i])=='undefined'){clearInterval(content_interval);$(window).trigger('load-completed');return;}
var item=items[i];i++;var li_content='<span class="name-text">'+item.name+'</span>';if(item.type&&item.type==='i'){li_content='<img src="'+SITE_URL+'files/cloud_thumb/'+item.id+'?'+new Date().getMilliseconds()+'" alt="'+item.name+'"/>'+li_content;}
$folders_center.append('<li class="files-tooltip '+item.el_type+' '+(item.el_type==='file'?'type-'+item.type:'')+'" data-id="'+item.id+'" data-name="'+item.name+'">'+
li_content+'</li>');$(window).data(item.el_type+'_'+item.id,item);},150);pyro.files.current_level=folder_id;$('#file-breadcrumbs').find('.folder-crumb').remove();current=$(window).data('folder_'+folder_id);var url='';while(typeof(current)!=='undefined'){$('#file-breadcrumbs').find('#crumb-root').after('<span class="folder-crumb"> &nbsp;/&nbsp; <a data-id="'+current.id+'" href="#">'+current.name+'</a></span>');url=current.slug+'/'+url;current=$(window).data('folder_'+current.parent_id);}
if(url.length>0){window.location.hash='#'+url;}
$('ul#folders-sidebar [data-id="'+folder_id+'"] > ul:hidden').parent('li').children('div').trigger('click');$('ul#folders-sidebar').find('li').removeClass('current');$('ul#folders-sidebar [data-id="'+folder_id+'"]').not('.places').addClass('current');results.message=pyro.lang.fetch_completed;$(window).trigger('show-message',results);$('.item .folders-center').trigger('click');}});};pyro.files.rename=function(){var type=pyro.files.$last_r_click.hasClass('folder')?'folder':'file',$item=pyro.files.$last_r_click.find('.name-text');$('[name="rename"]').parent().html($('[name="rename"]').val());$item.html('<input name="rename" value="'+$item.html()+'"/>');$input=$item.find('input');$input.select();$input.keyup(function(e){if(e.which===13){$input.trigger('blur');}else{if($(this).val().length>49){$(this).val($(this).val().slice(0,50));}}});$input.blur(function(){var item_data,post={name:$input.val()};post[type+'_id']=$item.parent('li').attr('data-id');item_data=($(window).data(type+'_'+post[type+'_id'])||{});if($.isEmptyObject(item_data)||item_data.name!==post['name']){$.post(SITE_URL+'admin/files/rename_'+type,post,function(data){var results=$.parseJSON(data);$(window).trigger('show-message',results);$.extend(item_data,results.data);$(window).data(type+'_'+item_data.id,item_data);$('input[name="rename"]').parent().html(results.data.name);$('ul#folders-sidebar').find('[data-id="'+post.folder_id+'"] > a').html(results.data.name);$('.'+type+'[data-id="'+post[type+'_id']+'"]').attr('data-name',results.data.name);});}
$('input[name="rename"]').parent().html($('input[name="rename"]').val());});$input.keydown(function(e){if(e.which=='13')
{$(this).blur();return false;}});};pyro.files.replace=function(){pyro.files.mode='replace';$(window).trigger('open-upload');};pyro.files.delete_item=function(current_level){var items=$('.selected[data-id]'),type=items.length>0?'file':'folder';if(type==='file'||pyro.files.$last_r_click.hasClass('file')){if(items.length===0){items=pyro.files.$last_r_click;type='file';}}else{items=pyro.files.$last_r_click;}
items.each(function(index,item){var id=$(item).attr('data-id'),post_data={};post_data[type+'_id']=id;$.post(SITE_URL+'admin/files/delete_'+type,post_data,function(data){var results=$.parseJSON(data);if(results.status){$(window).removeData(type+'_'+id);switch(type){case'file':$('.folders-center .file[data-id="'+id+'"]').remove();break;case'folder':$('.folder[data-id="'+id+'"]').remove();$('.folder[data-id="'+current_level+'"] ul:empty').remove();$('.folder[data-id="'+current_level+'"]').removeClass('open close');break;}
if($folders_center.find('li').length===0&&pyro.files.current_level===0){$('.no_data').fadeIn('fast');}}
$(window).trigger('show-message',results);});});};$item_details=$('div#item-details');pyro.files.details=function(){var timer,location,type=pyro.files.$last_r_click.hasClass('file')?'file':'folder',$item_id=pyro.files.$last_r_click.attr('data-id').length>0?pyro.files.$last_r_click.attr('data-id'):pyro.files.current_level,$item=$(window).data(type+'_'+$item_id),$select=$item_details.find('.location');$item_details.find('li').hide();$item_details.find('.meta-data').hide();$item_details.find('.show-data > button').unbind().bind('click',function(){$item_details.find('.meta-data, .item-description').slideToggle();});if($item){if($item.id){$item_details.find('.id').html($item.id).parent().show();}
if($item.name){$item_details.find('.name').html($item.name).parent().show();}
if($item.slug){$item_details.find('.slug').html($item.slug).parent().show();}
if($item.path){$item_details.find('.path').val($item.path).parent().show();}
if($item.formatted_date){$item_details.find('.added').html($item.formatted_date).parent().show();}
if($item.width>0){$item_details.find('.width').html($item.width+'px').parent().show();}
if($item.height>0){$item_details.find('.height').html($item.height+'px').parent().show();}
if($item.filesize){$item_details.find('.filesize').html(($item.filesize<1000?$item.filesize+'Kb':$item.filesize/1000+'MB')).parent().show();}
if($item.download_count){$item_details.find('.download_count').html($item.download_count).parent().show();}
if($item.filename){$item_details.find('.filename').html($item.filename).parent().show();}
if(type==='file'){$item_details.find('.description').val($item.description).parent().show();}
if(type==='file'){$item_details.find('#keyword_input').val($item.keywords).parent().show();}
if(type==='file'){$item_details.find('.show-data').show();}
if($item.type==='i'){$item_details.find('.alt_attribute').val($item.alt_attribute).parent().show();}
if(type==='folder'&&$item.file_count===0&&pyro.files.has_permissions('set_location')){$select.val($item.location).find('option[value="'+$item.location+'"]').attr('selected',true);$select.trigger('liszt:updated').parents().show();}else if(type==='folder'){$item_details.find('.location-static').html($item.location).parent().show();if($item.remote_container>''){$item_details.find('.container-static').html($item.remote_container).parent().show();}}
$.ajaxSetup({allowEmpty:true});$('#keyword_input').tagsInput({autocomplete_url:SITE_URL+'admin/keywords/autocomplete'});$item_details.bind('cbox_closed',function(){$('#keyword_input_tagsinput').remove();$item_details.find('.buttons').off('click','button');});$select.change(function(e){location=$(e.target).val();$item_details.find('.container').parent().hide();$('.'+location).parent().show();});$('.container-button').on('click',function(e){var post_data={name:$(this).siblings('.container').val(),location:location};$.post(SITE_URL+'admin/files/check_container',post_data,function(data){var results=$.parseJSON(data);$(window).trigger('show-message',results);});});$.colorbox({scrolling:false,inline:true,href:'div#item-details',width:'520',height:(type==='file')?'600':'475',opacity:0});$item_details.find('.buttons').on('click','button',function(){if(type==='file'){pyro.files.save_description($item);}else{pyro.files.save_location($item);}
$.colorbox.close();});}};pyro.files.save_description=function(item){var new_description=$item_details.find('textarea.description').val(),new_keywords=$item_details.find('#keyword_input').val(),new_alt_attribute=$item_details.find('input.alt_attribute').val(),post_data={file_id:item.id,description:new_description,keywords:new_keywords,old_hash:item.keywords_hash,alt_attribute:new_alt_attribute};if(item.description!==new_description||item.keywords!==new_keywords||item.alt_attribute!==new_alt_attribute){$.post(SITE_URL+'admin/files/save_description',post_data,function(data){var results=$.parseJSON(data);$(window).trigger('show-message',results);item.description=new_description;item.keywords=new_keywords;item.keywords_hash=results.data.keywords_hash;item.alt_attribute=new_alt_attribute;$(window).data('file_'+item.id,item);});}};pyro.files.save_location=function(item){var new_location=$item_details.find('.location').val(),container=$('div#item-details .'+new_location).val(),post_data={folder_id:item.id,location:new_location,container:container};$.post(SITE_URL+'admin/files/save_location',post_data,function(data){var results=$.parseJSON(data);$(window).trigger('show-message',results);if(results.status){item.location=new_location;item.remote_container=container;$(window).data('folder_'+item.id,item);}});};pyro.files.synchronize=function(){var folder_id=pyro.files.$last_r_click.attr('data-id'),post_data={folder_id:folder_id};$(window).trigger('show-message',{status:null,message:pyro.lang.synchronization_started});$.post(SITE_URL+'admin/files/synchronize',post_data,function(data){var results=$.parseJSON(data);$(window).trigger('show-message',results);if(results.status){pyro.files.folder_contents(folder_id);}});};pyro.files.has_permissions=function(roles){var actions=roles.split(' ');var max_actions=actions.length;for(var x=0;x<max_actions;x++)
{if($.inArray(actions[x],pyro.files.permissions)===-1)
{return false;}}
return true;}
if($('.folders-center').find('.no_data').length===0){if(window.location.hash){pyro.files.folder_contents(window.location.hash);}else{pyro.files.folder_contents(pyro.files.initial_folder_contents);}}});
